{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/taxonfinder/output-full.schema.json",
  "title": "TaxonFinder Output (Full, --all-occurrences)",
  "description": "Full output format: one entry per occurrence, wrapped in a versioned envelope. Used with --all-occurrences flag.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "results"
  ],
  "properties": {
    "version": {
      "type": "string",
      "const": "1.0",
      "description": "Output format version. Incremented on breaking changes."
    },
    "results": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "line_number",
          "source_text",
          "source_context",
          "identified",
          "extraction_confidence",
          "extraction_method",
          "matches",
          "candidate_names",
          "reason"
        ],
        "properties": {
          "line_number": {
            "type": "integer",
            "minimum": 1,
            "description": "1-based line number in the input file."
          },
          "source_text": {
            "type": "string",
            "minLength": 1,
            "description": "Original text as found in the source (no normalization)."
          },
          "source_context": {
            "type": "string",
            "minLength": 1,
            "description": "Sentence containing the occurrence."
          },
          "identified": {
            "type": "boolean",
            "description": "Whether the taxon was successfully identified."
          },
          "extraction_confidence": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Confidence that the extracted fragment is a taxon name. See docs/processing.md for the confidence model."
          },
          "extraction_method": {
            "type": "string",
            "enum": [
              "gazetteer",
              "latin_regex",
              "llm"
            ],
            "description": "Method used to extract the candidate taxon name."
          },
          "matches": {
            "type": "array",
            "maxItems": 5,
            "description": "iNaturalist search results, sorted by score descending.",
            "items": {
              "$ref": "#/$defs/match"
            }
          },
          "llm_response": {
            "$ref": "#/$defs/llm_response"
          },
          "candidate_names": {
            "type": "array",
            "items": {
              "type": "string",
              "minLength": 1
            },
            "description": "Candidate names tried during resolution (empty when identified=true)."
          },
          "reason": {
            "type": "string",
            "description": "Diagnostic message explaining resolution result (empty when identified=true)."
          }
        }
      }
    }
  },
  "$defs": {
    "taxonomy": {
      "type": "object",
      "additionalProperties": false,
      "minProperties": 1,
      "description": "Taxonomic hierarchy of the taxon. At least one level must be present. Verify minProperties constraint during development.",
      "properties": {
        "kingdom": {
          "type": [
            "string",
            "null"
          ],
          "description": "Kingdom (e.g. Animalia, Plantae)."
        },
        "phylum": {
          "type": [
            "string",
            "null"
          ],
          "description": "Phylum/Division (e.g. Chordata, Tracheophyta)."
        },
        "class": {
          "type": [
            "string",
            "null"
          ],
          "description": "Class (e.g. Aves, Mammalia). Python dataclass field: class_ (reserved word); serialized as 'class' in JSON."
        },
        "order": {
          "type": [
            "string",
            "null"
          ],
          "description": "Order (e.g. Passeriformes, Rosales)."
        },
        "family": {
          "type": [
            "string",
            "null"
          ],
          "description": "Family (e.g. Anatidae, Rosaceae)."
        },
        "genus": {
          "type": [
            "string",
            "null"
          ],
          "description": "Genus (e.g. Tilia, Quercus)."
        },
        "species": {
          "type": [
            "string",
            "null"
          ],
          "description": "Species (matches taxon_name for species-level taxa)."
        }
      }
    },
    "match": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "taxon_id",
        "taxon_name",
        "taxon_rank",
        "taxonomy",
        "taxon_common_name_en",
        "taxon_common_name_loc",
        "taxon_matched_name",
        "taxon_url",
        "score"
      ],
      "properties": {
        "taxon_id": {
          "type": "integer",
          "minimum": 1,
          "description": "iNaturalist taxon ID."
        },
        "taxon_name": {
          "type": "string",
          "minLength": 1,
          "description": "Scientific (Latin) name."
        },
        "taxon_rank": {
          "type": "string",
          "minLength": 1,
          "description": "Taxonomic rank (e.g. species, genus)."
        },
        "taxonomy": {
          "$ref": "#/$defs/taxonomy"
        },
        "taxon_common_name_en": {
          "type": [
            "string",
            "null"
          ],
          "description": "English common name (always loaded for portability)."
        },
        "taxon_common_name_loc": {
          "type": [
            "string",
            "null"
          ],
          "description": "Common name for the configured locale."
        },
        "taxon_matched_name": {
          "type": "string",
          "minLength": 1,
          "description": "Name by which the taxon was matched."
        },
        "taxon_url": {
          "type": "string",
          "format": "uri",
          "description": "URL to the taxon page on iNaturalist."
        },
        "score": {
          "type": "number",
          "description": "Relevance score from iNaturalist API or synthetic score for gazetteer matches."
        }
      }
    },
    "llm_response": {
      "type": [
        "object",
        "null"
      ],
      "description": "LLM enricher response (if LLM was consulted).",
      "additionalProperties": false,
      "required": [
        "common_names_loc",
        "common_names_en",
        "latin_names"
      ],
      "properties": {
        "common_names_loc": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "Common names in the text language (locale from config)."
        },
        "common_names_en": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "English common names suggested by LLM."
        },
        "latin_names": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "Latin (scientific) names suggested by LLM."
        }
      }
    }
  }
}
